<view class="container">
  <!-- 冲突提示横幅 -->
  <van-notice-bar wx:if="{{hasConflict}}" mode="closeable"
    text="{{conflictMsg}}" bind:close="onDismissConflict"
    left-icon="warning-o" color="#ed6a0c" background="#fffbe8" />

  <van-tabs active="{{activeTab}}" bind:change="onModeChange">
    <van-tab title="简单模式" name="simple">
      <van-cell-group title="输入每位玩家筹码变动">
        <van-cell wx:for="{{players}}" wx:key="_id" title="{{item.nickname}}" label="当前: {{item.currentChips}}">
          <van-field slot="right-icon" type="digit" placeholder="+/-"
            data-index="{{index}}" bind:change="onDeltaChange"
            custom-style="text-align:right;width:200rpx;" />
        </van-cell>
      </van-cell-group>
      <view class="summary">
        <text class="{{balanceOk ? 'text-ok' : 'text-err'}}">差额: {{balance}}</text>
      </view>
      <van-button type="primary" block bind:click="onConfirm"
        disabled="{{!balanceOk}}" loading="{{loading}}">确认记录</van-button>
    </van-tab>

    <van-tab title="Side Pot" name="sidepot">
      <!-- 街道指示器 -->
      <view class="street-indicator">
        <view wx:for="{{streets}}" wx:key="*this"
          class="street-step {{index < currentStreetIdx ? 'street-done' : index === currentStreetIdx ? 'street-active' : 'street-future'}}">
          <text class="street-dot">{{index < currentStreetIdx ? '✓' : index + 1}}</text>
          <text class="street-name">{{streetLabels[item]}}</text>
        </view>
      </view>

      <!-- 所有人弃牌只剩一人 -->
      <view wx:if="{{allFoldedExceptOne}}" class="all-fold-notice">
        <text>所有人弃牌，{{lastPlayerName}} 赢得底池</text>
      </view>

      <van-cell-group title="{{streetLabels[currentStreet]}} — 输入下注额">
        <view wx:for="{{players}}" wx:key="_id" class="bet-row {{folded[index] ? 'bet-row-folded' : ''}}">
          <van-cell title="{{item.nickname}}" label="当前: {{item.currentChips}}">
            <view slot="right-icon" class="bet-right">
              <van-field wx:if="{{!folded[index]}}" type="number" placeholder="下注额"
                value="{{bets[index] || ''}}"
                data-index="{{index}}" bind:change="onBetChange"
                custom-style="text-align:right;width:160rpx;" />
              <text wx:if="{{folded[index]}}" class="fold-text">已弃牌 ({{bets[index]}})</text>
              <van-button wx:if="{{!folded[index]}}" size="mini" type="danger" plain
                data-index="{{index}}" bind:click="onFold">弃牌</van-button>
              <van-button wx:if="{{folded[index]}}" size="mini" type="info" plain
                data-index="{{index}}" bind:click="onUnfold">恢复</van-button>
            </view>
          </van-cell>
        </view>
      </van-cell-group>

      <!-- 街道导航按钮 -->
      <view class="street-nav">
        <van-button wx:if="{{currentStreetIdx > 0}}" size="small" plain
          bind:click="onPrevStreet">上一轮</van-button>
        <view wx:else></view>
        <van-button wx:if="{{currentStreetIdx < 3 && !allFoldedExceptOne}}" size="small" type="info"
          bind:click="onNextStreet">下一轮 →</van-button>
      </view>

      <view wx:if="{{pots.length > 0}}" class="pots-section">
        <van-cell-group title="底池分配 — 选择每个底池赢家">
          <view wx:for="{{pots}}" wx:for-item="pot" wx:for-index="potIdx"
            wx:key="potIdx" class="pot-item">
            <view class="pot-head">
              <text class="pot-label">底池 {{potIdx + 1}}</text>
              <text class="pot-amt">{{pot.amount}} 筹码</text>
            </view>
            <view class="pot-elig">
              有资格:
              <text wx:for="{{pot.eligibleNames}}" wx:for-item="n"
                wx:key="*this" class="elig-name">{{n}}</text>
            </view>
            <view class="pot-winner">
              <text class="win-label">赢家:</text>
              <van-radio-group wx:if="{{pot.eligible.length > 1}}"
                value="{{potWinners[potIdx]}}"
                data-pot-index="{{potIdx}}" bind:change="onWinnerSelect"
                direction="horizontal">
                <van-radio wx:for="{{pot.eligible}}" wx:for-item="eid"
                  wx:for-index="eidx" wx:key="*this" name="{{eid}}"
                  custom-class="win-radio">{{pot.eligibleNames[eidx]}}</van-radio>
              </van-radio-group>
              <text wx:else class="auto-win">{{pot.eligibleNames[0]}}（自动）</text>
            </view>
          </view>
        </van-cell-group>
      </view>

      <view wx:if="{{spChanges.length > 0}}" class="changes-section">
        <van-cell-group title="筹码变动预览">
          <van-cell wx:for="{{spChanges}}" wx:key="openId"
            title="{{item.nickname}}">
            <text class="{{item.delta >= 0 ? 'text-ok' : 'text-err'}}">
              {{item.delta >= 0 ? '+' : ''}}{{item.delta}}
            </text>
          </van-cell>
        </van-cell-group>
        <view class="summary">
          <text class="{{spReady ? 'text-ok' : 'text-err'}}">差额: {{spBalance}}</text>
        </view>
      </view>

      <van-button type="primary" block bind:click="onConfirm"
        disabled="{{!spReady && !allFoldedExceptOne}}" loading="{{loading}}">确认记录</van-button>
    </van-tab>
  </van-tabs>
</view>
