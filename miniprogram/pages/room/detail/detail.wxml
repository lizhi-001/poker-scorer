<view class="container">
  <view class="card">
    <view class="room-header">
      <text class="room-name">{{room.name}}</text>
      <van-tag type="{{room.status === 'waiting' ? 'warning' : room.status === 'active' ? 'success' : 'default'}}">
        {{room.status === 'waiting' ? '等待中' : room.status === 'active' ? '进行中' : '已结算'}}
      </van-tag>
    </view>
    <view class="room-info">盲注 {{room.smallBlind}}/{{room.bigBlind}} · 买入 {{room.buyIn}}</view>
    <view class="room-code" wx:if="{{room.roomCode}}" bind:tap="onCopyRoomCode">
      房间号: <text class="code-text">{{room.roomCode}}</text>
      <text class="copy-hint">点击复制</text>
    </view>
  </view>

  <view class="section-title">玩家 ({{players.length}}人)</view>

  <view class="player-list">
    <van-swipe-cell
      wx:for="{{players}}"
      wx:key="_id"
      right-width="{{ 65 }}"
    >
      <view class="player-card">
        <view class="player-main">
          <view class="player-name">{{item.nickname}}</view>
          <view class="player-chips">
            <text class="chips-value">{{item.currentChips}}</text>
            <text class="chips-label">筹码</text>
          </view>
        </view>
        <view class="player-meta">
          <text class="meta-text">买入 {{item.buyInCount}}次 · 共{{item.totalBuyIn}}</text>
          <text
            class="{{item.currentChips - item.totalBuyIn >= 0 ? 'profit-positive' : 'profit-negative'}}"
          >{{item.currentChips - item.totalBuyIn >= 0 ? '+' : ''}}{{item.currentChips - item.totalBuyIn}}</text>
        </view>
        <view class="player-actions">
          <van-button
            size="small"
            type="info"
            plain
            data-id="{{item._id}}"
            bind:click="onOpenBuyIn"
          >买入</van-button>
        </view>
      </view>
      <view slot="right" class="swipe-delete" data-id="{{item._id}}" bind:tap="onRemovePlayer">
        移除
      </view>
    </van-swipe-cell>
  </view>

  <van-empty wx:if="{{players.length === 0}}" description="暂无玩家，点击下方添加" />

  <!-- waiting: 可添加玩家、开始游戏 -->
  <view class="actions" wx:if="{{room.status === 'waiting'}}">
    <van-button type="info" block bind:click="onAddPlayer">添加玩家</van-button>
    <van-button type="primary" block bind:click="onStartGame" disabled="{{players.length < 2}}">
      开始游戏 {{players.length < 2 ? '(至少2人)' : ''}}
    </van-button>
    <van-button plain type="info" block bind:click="onShareRoom">邀请好友</van-button>
  </view>

  <!-- active: 可记录牌局、添加玩家、结算 -->
  <view class="actions" wx:elif="{{room.status === 'active'}}">
    <van-button type="info" block bind:click="onAddPlayer">添加玩家</van-button>
    <van-button type="primary" block bind:click="onStartRound" disabled="{{players.length < 2}}">记录一手牌</van-button>
    <van-button plain type="info" block bind:click="onViewRounds">查看手牌历史</van-button>
    <van-button type="warning" block bind:click="onSettle">结算牌局</van-button>
  </view>

  <!-- settled: 只读 -->
  <view class="settled-tip" wx:elif="{{room.status === 'settled'}}">
    <van-empty description="牌局已结算" />
  </view>

  <!-- 买入弹窗 -->
  <van-dialog
    use-slot
    show="{{ showBuyInDialog }}"
    title="追加买入"
    show-cancel-button
    bind:confirm="onConfirmBuyIn"
    bind:close="onCloseBuyIn"
  >
    <van-field
      label="金额"
      type="number"
      placeholder="输入买入金额"
      value="{{ buyInAmount }}"
      bind:change="onBuyInAmountChange"
    />
  </van-dialog>
</view>
